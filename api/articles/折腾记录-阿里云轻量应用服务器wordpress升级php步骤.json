{"title":"WordPress | 阿里云轻量应用服务器wordpress升级php步骤","slug":"折腾记录-阿里云轻量应用服务器wordpress升级php步骤","date":"2020-02-24T02:43:08.000Z","updated":"2020-02-24T02:43:08.000Z","comments":true,"path":"api/articles/折腾记录-阿里云轻量应用服务器wordpress升级php步骤.json","excerpt":"当我买了阿里云轻量应用服务器wordpress镜像后，发现很多主题需要升级php…","covers":["https://cdn.jsdelivr.net/gh/Justlovesmile/CDN2/post/20210304220934.png","https://cdn.jsdelivr.net/gh/Justlovesmile/CDN2/post/20210304221206.png"],"content":"<p>当我买了阿里云轻量应用服务器wordpress镜像后，发现很多主题需要升级php…</p>\n<span id=\"more\"></span>\n\n\n<h2 id=\"1-首先更新依赖包。\"><a href=\"#1-首先更新依赖包。\" class=\"headerlink\" title=\"1.首先更新依赖包。\"></a>1.首先更新依赖包。</h2><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">yum -y update</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-安装依赖包\"><a href=\"#2-安装依赖包\" class=\"headerlink\" title=\"2.安装依赖包\"></a>2.安装依赖包</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">yum</span> -y install libxml<span class=\"number\">2</span> libxml<span class=\"number\">2</span>-devel openssl openssl-devel bzip<span class=\"number\">2</span> bzip<span class=\"number\">2</span>-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel zlib zlib-devel glibc glibc-devel glib<span class=\"number\">2</span> glib<span class=\"number\">2</span>-devel ncurses curl gdbm-devel db<span class=\"number\">4</span>-devel libXpm-devel libX<span class=\"number\">11</span>-devel gd-devel gmp-devel expat-devel xmlrpc-c xmlrpc-c-devel libicu-devel libmcrypt-devel libmemcached-devel libzip gcc-c++</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-转到-usr-local-src-目录，下载php7-3-5\"><a href=\"#3-转到-usr-local-src-目录，下载php7-3-5\" class=\"headerlink\" title=\"3.转到 /usr/local/src 目录，下载php7.3.5\"></a>3.转到 /usr/local/src 目录，下载php7.3.5</h2><p><code>cd /usr/local/src</code><br><code>wget https://www.php.net/distributions/php-7.3.5.tar.gz</code></p>\n<h2 id=\"4-解压安装包-并进入目录\"><a href=\"#4-解压安装包-并进入目录\" class=\"headerlink\" title=\"4.解压安装包,并进入目录\"></a>4.解压安装包,并进入目录</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">tar</span> -zxvf php-<span class=\"number\">7</span>.<span class=\"number\">3</span>.<span class=\"number\">5</span>.tar.gz</span><br><span class=\"line\"><span class=\"attribute\">cd</span> php-<span class=\"number\">7</span>.<span class=\"number\">3</span>.<span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-添加用户和组\"><a href=\"#5-添加用户和组\" class=\"headerlink\" title=\"5.添加用户和组\"></a>5.添加用户和组</h2><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">groupadd www</span></span><br><span class=\"line\"><span class=\"attribute\">useradd -g www www</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-开始编译\"><a href=\"#6-开始编译\" class=\"headerlink\" title=\"6.开始编译\"></a>6.开始编译</h2><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/php</span> <span class=\"params\">--with-fpm-user=www</span> <span class=\"params\">--with-fpm-group=www</span> <span class=\"params\">--with-curl</span> <span class=\"params\">--with-freetype-dir</span> <span class=\"params\">--with-gd</span> <span class=\"params\">--with-gettext</span> <span class=\"params\">--with-iconv-dir</span> <span class=\"params\">--with-kerberos</span> <span class=\"params\">--with-libdir=lib64</span> <span class=\"params\">--with-libxml-dir</span> <span class=\"params\">--with-mysqli</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-pcre-regex</span> <span class=\"params\">--with-pdo-mysql</span> <span class=\"params\">--with-pdo-sqlite</span> <span class=\"params\">--with-pear</span> <span class=\"params\">--with-png-dir</span> <span class=\"params\">--with-jpeg-dir</span> <span class=\"params\">--with-xmlrpc</span> <span class=\"params\">--with-xsl</span> <span class=\"params\">--with-zlib</span> <span class=\"params\">--with-bz2</span> <span class=\"params\">--with-mhash</span> <span class=\"params\">--enable-fpm</span> <span class=\"params\">--enable-bcmath</span> <span class=\"params\">--enable-libxml</span> <span class=\"params\">--enable-inline-optimization</span> <span class=\"params\">--enable-mbregex</span> <span class=\"params\">--enable-mbstring</span> <span class=\"params\">--enable-opcache</span> <span class=\"params\">--enable-pcntl</span> <span class=\"params\">--enable-shmop</span> <span class=\"params\">--enable-soap</span> <span class=\"params\">--enable-sockets</span> <span class=\"params\">--enable-sysvsem</span> <span class=\"params\">--enable-sysvshm</span> <span class=\"params\">--enable-xml</span> <span class=\"params\">--enable-zip</span> <span class=\"params\">--enable-fpm</span></span><br></pre></td></tr></table></figure>\n\n<p>这里会提示 <code>configure: error: Please reinstall the libzip distribution</code>，我们需要移除libzip,手动安装最新版本</p>\n<h2 id=\"7-安装libzip\"><a href=\"#7-安装libzip\" class=\"headerlink\" title=\"7.安装libzip\"></a>7.安装libzip</h2><p>（1）先安装cmake</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd <span class=\"regexp\">/usr/</span>local/src</span><br><span class=\"line\">wget https:<span class=\"regexp\">//gi</span>thub.com<span class=\"regexp\">/Kitware/</span>CMake<span class=\"regexp\">/releases/</span>download<span class=\"regexp\">/v3.14.3/</span>cmake-<span class=\"number\">3.14</span>.<span class=\"number\">3</span>.tar.gz</span><br><span class=\"line\">tar -zxvf cmake-<span class=\"number\">3.14</span>.<span class=\"number\">3</span>.tar.gz</span><br><span class=\"line\">cd cmake-<span class=\"number\">3.14</span>.<span class=\"number\">3</span></span><br><span class=\"line\">./bootstrap</span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<p>（2）再编译安装libzip</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">yum</span> remove libzip -y</span><br><span class=\"line\"><span class=\"attribute\">cd</span> /usr/local/src</span><br><span class=\"line\"><span class=\"attribute\">wget</span> https://libzip.org/download/libzip-<span class=\"number\">1</span>.<span class=\"number\">5</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\"><span class=\"attribute\">tar</span> -zxvf libzip-<span class=\"number\">1</span>.<span class=\"number\">5</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\"><span class=\"attribute\">cd</span> libzip-<span class=\"number\">1</span>.<span class=\"number\">5</span>.<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attribute\">mkdir</span> build</span><br><span class=\"line\"><span class=\"attribute\">cd</span> build</span><br><span class=\"line\"><span class=\"attribute\">cmake</span> ..</span><br><span class=\"line\"><span class=\"attribute\">make</span> &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<p>（3）执行以下命令</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi <span class=\"regexp\">/etc/</span>ld.so.conf</span><br><span class=\"line\"><span class=\"comment\">#添加如下几行</span></span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>local/lib64</span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>local/lib</span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>lib</span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>lib64</span><br><span class=\"line\"><span class=\"comment\">#保存退出</span></span><br><span class=\"line\">ldconfig -v </span><br><span class=\"line\"><span class=\"comment\"># 使之生效 </span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"8-再次编译PHP7-3\"><a href=\"#8-再次编译PHP7-3\" class=\"headerlink\" title=\"8.再次编译PHP7.3\"></a>8.再次编译PHP7.3</h2><p><code>make &amp;&amp; make install</code></p>\n<h2 id=\"9-编译完成后，添加环境变量\"><a href=\"#9-编译完成后，添加环境变量\" class=\"headerlink\" title=\"9.编译完成后，添加环境变量\"></a>9.编译完成后，添加环境变量</h2><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/profile</span><br><span class=\"line\"><span class=\"comment\">#添加以下内容到最后</span></span><br><span class=\"line\">PATH=<span class=\"variable\">$PATH</span><span class=\"symbol\">:/usr/local/php/bin&lt;br&gt;export</span> PATH</span><br><span class=\"line\"><span class=\"comment\">#刷新环境变量</span></span><br><span class=\"line\">source /etc/profile</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"10-配置文件\"><a href=\"#10-配置文件\" class=\"headerlink\" title=\"10.配置文件\"></a>10.配置文件</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将启动脚本复制到init.d中。</span></span><br><span class=\"line\">cp <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/src/</span>php-<span class=\"number\">7.3</span>.<span class=\"number\">5</span><span class=\"regexp\">/sapi/</span>fpm<span class=\"regexp\">/init.d.php-fpm /</span>etc<span class=\"regexp\">/init.d/</span>php-fpm73</span><br><span class=\"line\"><span class=\"comment\"># 给启动脚本加上执行权限</span></span><br><span class=\"line\">chmod +x <span class=\"regexp\">/etc/i</span>nit.d/php-fpm73</span><br><span class=\"line\"><span class=\"comment\"># 将默认配置文件复制为.conf文件</span></span><br><span class=\"line\">cp <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/php/</span>etc<span class=\"regexp\">/php-fpm.conf.default $&#123;PHP73_DIR&#125;/</span>etc/php-fpm.conf</span><br><span class=\"line\"><span class=\"comment\"># 添加pool的配置</span></span><br><span class=\"line\">cat &lt;&lt; EOF &gt; <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/php/</span>etc<span class=\"regexp\">/php-fpm.d/</span>www.conf</span><br><span class=\"line\">[www]</span><br><span class=\"line\">listen = <span class=\"regexp\">/home/</span>www<span class=\"regexp\">/logs/</span>php73-fpm.sock</span><br><span class=\"line\">listen.mode = <span class=\"number\">0666</span></span><br><span class=\"line\">user = www</span><br><span class=\"line\">group = www</span><br><span class=\"line\">pm = dynamic</span><br><span class=\"line\">pm.max_children = <span class=\"number\">128</span></span><br><span class=\"line\">pm.start_servers = <span class=\"number\">5</span></span><br><span class=\"line\">pm.min_spare_servers = <span class=\"number\">5</span></span><br><span class=\"line\">pm.max_spare_servers = <span class=\"number\">15</span></span><br><span class=\"line\">pm.max_requests = <span class=\"number\">300</span></span><br><span class=\"line\">rlimit_files = <span class=\"number\">1024</span></span><br><span class=\"line\">slowlog = <span class=\"regexp\">/home/</span>www<span class=\"regexp\">/logs/</span>php73-fpm-slow.log</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"11-修改apache\"><a href=\"#11-修改apache\" class=\"headerlink\" title=\"11.修改apache\"></a>11.修改apache</h2><p>镜像中默认是用的php-fpm，使用的是socket方式的监听，Apache对应配置文件<code>/usr/local/apache/conf/httpd.conf</code>，其中配置如下:</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Justlovesmile/CDN2/post/20210304220934.png\"></p>\n<p>需要修改其中socket的文件路径指向到新版本的PHP就可以了，在<code>/usr/local/php73/etc/php-fpm.d/www.conf</code>有指定，新的配置到<code>/home/www/logs/php73-fpm.sock</code>即可，如图:</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Justlovesmile/CDN2/post/20210304221206.png\"></p>\n<h2 id=\"12-重启服务\"><a href=\"#12-重启服务\" class=\"headerlink\" title=\"12.重启服务\"></a>12.重启服务</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 停止旧版本的PHP(实际不停止也不影响，停止可以减少一些系统资源占用)</span></span><br><span class=\"line\"><span class=\"regexp\">/etc/i</span>nit.d/php-fpm stop</span><br><span class=\"line\"><span class=\"comment\"># 启动新版PHP-FPM</span></span><br><span class=\"line\"><span class=\"regexp\">/etc/i</span>nit.d/php-fpm73 start</span><br><span class=\"line\"><span class=\"comment\">#启动报错请修改文件名</span></span><br><span class=\"line\">修改<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/php/</span>etc/php-fpm.conf.default为php-fpm.conf</span><br><span class=\"line\"><span class=\"comment\"># 重启apache</span></span><br><span class=\"line\"><span class=\"regexp\">/etc/i</span>nit.d/apachectl restart</span><br></pre></td></tr></table></figure>","more":"<h2 id=\"1-首先更新依赖包。\"><a href=\"#1-首先更新依赖包。\" class=\"headerlink\" title=\"1.首先更新依赖包。\"></a>1.首先更新依赖包。</h2><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">yum -y update</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-安装依赖包\"><a href=\"#2-安装依赖包\" class=\"headerlink\" title=\"2.安装依赖包\"></a>2.安装依赖包</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">yum</span> -y install libxml<span class=\"number\">2</span> libxml<span class=\"number\">2</span>-devel openssl openssl-devel bzip<span class=\"number\">2</span> bzip<span class=\"number\">2</span>-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel zlib zlib-devel glibc glibc-devel glib<span class=\"number\">2</span> glib<span class=\"number\">2</span>-devel ncurses curl gdbm-devel db<span class=\"number\">4</span>-devel libXpm-devel libX<span class=\"number\">11</span>-devel gd-devel gmp-devel expat-devel xmlrpc-c xmlrpc-c-devel libicu-devel libmcrypt-devel libmemcached-devel libzip gcc-c++</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-转到-usr-local-src-目录，下载php7-3-5\"><a href=\"#3-转到-usr-local-src-目录，下载php7-3-5\" class=\"headerlink\" title=\"3.转到 /usr/local/src 目录，下载php7.3.5\"></a>3.转到 /usr/local/src 目录，下载php7.3.5</h2><p><code>cd /usr/local/src</code><br><code>wget https://www.php.net/distributions/php-7.3.5.tar.gz</code></p>\n<h2 id=\"4-解压安装包-并进入目录\"><a href=\"#4-解压安装包-并进入目录\" class=\"headerlink\" title=\"4.解压安装包,并进入目录\"></a>4.解压安装包,并进入目录</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">tar</span> -zxvf php-<span class=\"number\">7</span>.<span class=\"number\">3</span>.<span class=\"number\">5</span>.tar.gz</span><br><span class=\"line\"><span class=\"attribute\">cd</span> php-<span class=\"number\">7</span>.<span class=\"number\">3</span>.<span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-添加用户和组\"><a href=\"#5-添加用户和组\" class=\"headerlink\" title=\"5.添加用户和组\"></a>5.添加用户和组</h2><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">groupadd www</span></span><br><span class=\"line\"><span class=\"attribute\">useradd -g www www</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-开始编译\"><a href=\"#6-开始编译\" class=\"headerlink\" title=\"6.开始编译\"></a>6.开始编译</h2><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/php</span> <span class=\"params\">--with-fpm-user=www</span> <span class=\"params\">--with-fpm-group=www</span> <span class=\"params\">--with-curl</span> <span class=\"params\">--with-freetype-dir</span> <span class=\"params\">--with-gd</span> <span class=\"params\">--with-gettext</span> <span class=\"params\">--with-iconv-dir</span> <span class=\"params\">--with-kerberos</span> <span class=\"params\">--with-libdir=lib64</span> <span class=\"params\">--with-libxml-dir</span> <span class=\"params\">--with-mysqli</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-pcre-regex</span> <span class=\"params\">--with-pdo-mysql</span> <span class=\"params\">--with-pdo-sqlite</span> <span class=\"params\">--with-pear</span> <span class=\"params\">--with-png-dir</span> <span class=\"params\">--with-jpeg-dir</span> <span class=\"params\">--with-xmlrpc</span> <span class=\"params\">--with-xsl</span> <span class=\"params\">--with-zlib</span> <span class=\"params\">--with-bz2</span> <span class=\"params\">--with-mhash</span> <span class=\"params\">--enable-fpm</span> <span class=\"params\">--enable-bcmath</span> <span class=\"params\">--enable-libxml</span> <span class=\"params\">--enable-inline-optimization</span> <span class=\"params\">--enable-mbregex</span> <span class=\"params\">--enable-mbstring</span> <span class=\"params\">--enable-opcache</span> <span class=\"params\">--enable-pcntl</span> <span class=\"params\">--enable-shmop</span> <span class=\"params\">--enable-soap</span> <span class=\"params\">--enable-sockets</span> <span class=\"params\">--enable-sysvsem</span> <span class=\"params\">--enable-sysvshm</span> <span class=\"params\">--enable-xml</span> <span class=\"params\">--enable-zip</span> <span class=\"params\">--enable-fpm</span></span><br></pre></td></tr></table></figure>\n\n<p>这里会提示 <code>configure: error: Please reinstall the libzip distribution</code>，我们需要移除libzip,手动安装最新版本</p>\n<h2 id=\"7-安装libzip\"><a href=\"#7-安装libzip\" class=\"headerlink\" title=\"7.安装libzip\"></a>7.安装libzip</h2><p>（1）先安装cmake</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd <span class=\"regexp\">/usr/</span>local/src</span><br><span class=\"line\">wget https:<span class=\"regexp\">//gi</span>thub.com<span class=\"regexp\">/Kitware/</span>CMake<span class=\"regexp\">/releases/</span>download<span class=\"regexp\">/v3.14.3/</span>cmake-<span class=\"number\">3.14</span>.<span class=\"number\">3</span>.tar.gz</span><br><span class=\"line\">tar -zxvf cmake-<span class=\"number\">3.14</span>.<span class=\"number\">3</span>.tar.gz</span><br><span class=\"line\">cd cmake-<span class=\"number\">3.14</span>.<span class=\"number\">3</span></span><br><span class=\"line\">./bootstrap</span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<p>（2）再编译安装libzip</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">yum</span> remove libzip -y</span><br><span class=\"line\"><span class=\"attribute\">cd</span> /usr/local/src</span><br><span class=\"line\"><span class=\"attribute\">wget</span> https://libzip.org/download/libzip-<span class=\"number\">1</span>.<span class=\"number\">5</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\"><span class=\"attribute\">tar</span> -zxvf libzip-<span class=\"number\">1</span>.<span class=\"number\">5</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\"><span class=\"attribute\">cd</span> libzip-<span class=\"number\">1</span>.<span class=\"number\">5</span>.<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attribute\">mkdir</span> build</span><br><span class=\"line\"><span class=\"attribute\">cd</span> build</span><br><span class=\"line\"><span class=\"attribute\">cmake</span> ..</span><br><span class=\"line\"><span class=\"attribute\">make</span> &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<p>（3）执行以下命令</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi <span class=\"regexp\">/etc/</span>ld.so.conf</span><br><span class=\"line\"><span class=\"comment\">#添加如下几行</span></span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>local/lib64</span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>local/lib</span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>lib</span><br><span class=\"line\"><span class=\"regexp\">/usr/</span>lib64</span><br><span class=\"line\"><span class=\"comment\">#保存退出</span></span><br><span class=\"line\">ldconfig -v </span><br><span class=\"line\"><span class=\"comment\"># 使之生效 </span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"8-再次编译PHP7-3\"><a href=\"#8-再次编译PHP7-3\" class=\"headerlink\" title=\"8.再次编译PHP7.3\"></a>8.再次编译PHP7.3</h2><p><code>make &amp;&amp; make install</code></p>\n<h2 id=\"9-编译完成后，添加环境变量\"><a href=\"#9-编译完成后，添加环境变量\" class=\"headerlink\" title=\"9.编译完成后，添加环境变量\"></a>9.编译完成后，添加环境变量</h2><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/profile</span><br><span class=\"line\"><span class=\"comment\">#添加以下内容到最后</span></span><br><span class=\"line\">PATH=<span class=\"variable\">$PATH</span><span class=\"symbol\">:/usr/local/php/bin&lt;br&gt;export</span> PATH</span><br><span class=\"line\"><span class=\"comment\">#刷新环境变量</span></span><br><span class=\"line\">source /etc/profile</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"10-配置文件\"><a href=\"#10-配置文件\" class=\"headerlink\" title=\"10.配置文件\"></a>10.配置文件</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将启动脚本复制到init.d中。</span></span><br><span class=\"line\">cp <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/src/</span>php-<span class=\"number\">7.3</span>.<span class=\"number\">5</span><span class=\"regexp\">/sapi/</span>fpm<span class=\"regexp\">/init.d.php-fpm /</span>etc<span class=\"regexp\">/init.d/</span>php-fpm73</span><br><span class=\"line\"><span class=\"comment\"># 给启动脚本加上执行权限</span></span><br><span class=\"line\">chmod +x <span class=\"regexp\">/etc/i</span>nit.d/php-fpm73</span><br><span class=\"line\"><span class=\"comment\"># 将默认配置文件复制为.conf文件</span></span><br><span class=\"line\">cp <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/php/</span>etc<span class=\"regexp\">/php-fpm.conf.default $&#123;PHP73_DIR&#125;/</span>etc/php-fpm.conf</span><br><span class=\"line\"><span class=\"comment\"># 添加pool的配置</span></span><br><span class=\"line\">cat &lt;&lt; EOF &gt; <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/php/</span>etc<span class=\"regexp\">/php-fpm.d/</span>www.conf</span><br><span class=\"line\">[www]</span><br><span class=\"line\">listen = <span class=\"regexp\">/home/</span>www<span class=\"regexp\">/logs/</span>php73-fpm.sock</span><br><span class=\"line\">listen.mode = <span class=\"number\">0666</span></span><br><span class=\"line\">user = www</span><br><span class=\"line\">group = www</span><br><span class=\"line\">pm = dynamic</span><br><span class=\"line\">pm.max_children = <span class=\"number\">128</span></span><br><span class=\"line\">pm.start_servers = <span class=\"number\">5</span></span><br><span class=\"line\">pm.min_spare_servers = <span class=\"number\">5</span></span><br><span class=\"line\">pm.max_spare_servers = <span class=\"number\">15</span></span><br><span class=\"line\">pm.max_requests = <span class=\"number\">300</span></span><br><span class=\"line\">rlimit_files = <span class=\"number\">1024</span></span><br><span class=\"line\">slowlog = <span class=\"regexp\">/home/</span>www<span class=\"regexp\">/logs/</span>php73-fpm-slow.log</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"11-修改apache\"><a href=\"#11-修改apache\" class=\"headerlink\" title=\"11.修改apache\"></a>11.修改apache</h2><p>镜像中默认是用的php-fpm，使用的是socket方式的监听，Apache对应配置文件<code>/usr/local/apache/conf/httpd.conf</code>，其中配置如下:</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Justlovesmile/CDN2/post/20210304220934.png\"></p>\n<p>需要修改其中socket的文件路径指向到新版本的PHP就可以了，在<code>/usr/local/php73/etc/php-fpm.d/www.conf</code>有指定，新的配置到<code>/home/www/logs/php73-fpm.sock</code>即可，如图:</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Justlovesmile/CDN2/post/20210304221206.png\"></p>\n<h2 id=\"12-重启服务\"><a href=\"#12-重启服务\" class=\"headerlink\" title=\"12.重启服务\"></a>12.重启服务</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 停止旧版本的PHP(实际不停止也不影响，停止可以减少一些系统资源占用)</span></span><br><span class=\"line\"><span class=\"regexp\">/etc/i</span>nit.d/php-fpm stop</span><br><span class=\"line\"><span class=\"comment\"># 启动新版PHP-FPM</span></span><br><span class=\"line\"><span class=\"regexp\">/etc/i</span>nit.d/php-fpm73 start</span><br><span class=\"line\"><span class=\"comment\">#启动报错请修改文件名</span></span><br><span class=\"line\">修改<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/php/</span>etc/php-fpm.conf.default为php-fpm.conf</span><br><span class=\"line\"><span class=\"comment\"># 重启apache</span></span><br><span class=\"line\"><span class=\"regexp\">/etc/i</span>nit.d/apachectl restart</span><br></pre></td></tr></table></figure>","categories":[{"name":"折腾记录","path":"api/categories/折腾记录.json"}],"tags":[{"name":"linux","path":"api/tags/linux.json"},{"name":"阿里云","path":"api/tags/阿里云.json"},{"name":"php","path":"api/tags/php.json"}]}